<!DOCTYPE html>

<html lang="zh-CN">
<head>
<title>让NumberPicker及时朗读值的改变的方法</title>
<link rel="stylesheet" href="../style.css" />
<meta charset="utf-8">
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery.zclip.min.js"></script>
<script type="text/javascript">
$(function(){ 
    $('#copy_input1').zclip({ 
        path: 'js/ZeroClipboard.swf', 
        copy: function(){//复制内容 
            return $('#code1').val(); 
        }, 
        afterCopy: function(){//复制成功 
            $("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功'); 
        } 
    }); 
}); 
$(function(){ 
    $('#copy_input2').zclip({ 
        path: 'js/ZeroClipboard.swf', 
        copy: function(){//复制内容 
            return $('#code2').val(); 
        }, 
        afterCopy: function(){//复制成功 
            $("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功'); 
        } 
    }); 
}); 
$(function(){ 
    $('#copy_input3').zclip({ 
        path: 'js/ZeroClipboard.swf', 
        copy: function(){//复制内容 
            return $('#code3').val(); 
        }, 
        afterCopy: function(){//复制成功 
            $("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功'); 
        } 
    }); 
}); 
</script>
</head>
<body>
<div class="wrap">
<!-- header begin -->
<div class="header">
    <div ><a href="http://www.siaa.org.cn/"><img src="../logo.png" alt="信息无障碍研究会"  class="logo"/></a></div>
    <!-- nav bar begin -->
    <div class="nav-bar">
        <!-- nav menu begin -->
        <ul>
            <li><a href="../index.html">首页</a></li>
            <li><a href="../index.html">返回</a></li>
        </ul>
        <!-- nav menu end -->
    </div>
    <!-- nav bar end -->
</div>
<!-- header end -->

<!-- body begin -->
<div class="body">
    <h3>让NumberPicker及时朗读值的改变的方法____20160530</h3>
    <hr />
    <div>
        <h4>【问题描述】</h4>
        <hr />
        <p>标准控<code>NumberPicker</code>的值改变之后不能及时朗读出改变之后的值，用户需要重新使<code>NumberPicker</code>获得焦点才能知道当前的值。这给用户操作<code>NumberPicker</code>带来一些困扰。</p><!--问题说明-->
    </div>
    <div>
        <h4>【问题代码】</h4>
        <hr />
        <p>下面代码中的<code>NumberPicker</code>的值改变的时候不能及时朗读出，用户需要重新让<code>NumberPicker</code>获得焦点才能知道<code>NumberPicker</code>的值。</p>
<p>注：布局文件的代码请参见“<a href="#fujian1">附1</a>“。
</p>
        <textarea rows="60" cols="120" aria-label="问题代码" id="code1">
import android.app.Activity;
import android.os.Bundle;
import android.support.v4.view.AccessibilityDelegateCompat;
import android.support.v4.view.ViewCompat;
import android.view.View;
import android.view.accessibility.AccessibilityEvent;
import android.widget.NumberPicker;
import android.widget.NumberPicker.OnValueChangeListener;
import android.widget.TextView;

public class MainActivity extends Activity
{
	NumberPicker np1, np2;
	TextView result;
	// 定义最低价格、最高价格的初始值
	int minPrice = 25, maxPrice = 75;
	@Override
	protected void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);
		
		result = (TextView) findViewById(R.id.result);
		np1 = (NumberPicker) findViewById(R.id.np1);
		// 设置np1的最小值和最大值
		np1.setMinValue(10);
		np1.setMaxValue(50);
		// 设置np1的当前值
		np1.setValue(minPrice);
		np1.setOnLongPressUpdateInterval(200);
		np1.setOnValueChangedListener(new OnValueChangeListener()
		{
			// 当NumberPicker的值发生改变时，将会激发该方法
			@Override
			public void onValueChange(NumberPicker picker,int oldVal, int newVal)
			{
				minPrice = newVal;
				result.setText("你的选择是：最低价格"+ String.valueOf(minPrice) +"最高价格"+ String.valueOf(maxPrice));
			}
		});
		np2 = (NumberPicker) findViewById(R.id.np2);
		// 设置np2的最小值和最大值
		np2.setMinValue(60);
		np2.setMaxValue(100);
		// 设置np2的当前值
		np2.setValue(maxPrice);
		np2.setOnValueChangedListener(new OnValueChangeListener()
		{
			// 当NumberPicker的值发生改变时，将会激发该方法
			@Override
			public void onValueChange(NumberPicker picker, int oldVal,int newVal)
			{
				maxPrice = newVal;
				result.setText("你的选择是：最低价格"+ String.valueOf(minPrice) +"最高价格"+ String.valueOf(maxPrice));
}
});
}
}
        </textarea><br/>
        <a href="#" id="copy_input1" class="copy">复制内容</a> 
    </div>
    <div>
        <h4>【问题解决方案描述】</h4>
        <hr />
        <p>利用<code>View</code>类的<code>setAccessibilityDelegate(View.AccessibilityDelegate)</code>方法或<code>ViewCompat</code>类的<code>setAccessibilityDelegate(View, AccessibilityDelegateCompat)</code>方法（此方法可以兼容到api4）给<code>NumberPicker</code>设置无障碍代理，在代理中重写<code>sendAccessibilityEvent()</code>方法，因为此方法在<code>NumberPicker</code>中什么都没有做，重写<code>onPopulateAccessibilityEvent()</code>方法在此方法中添加<code>NumberPicker</code>的文本，文本内容是<code>NumberPicker</code>的当前值。给<code>NumberPicker</code>添加<code>onValueChangeListener</code>监听器，并在此监听器中用<code>sendAccessibilityEvent(AccessibilityEvent_TYPE_VIEW_SELECTED)</code>发送无障碍事件。</p>
    </div>
    <div>
        <h4>【解决方案】</h4>
        <hr />
		<p>下面的代码达到的效果是当<code>NumberPicker</code>的值改变之后能及时朗读出当前的值。</p>
        <textarea rows="70" cols="120" aria-label="解决方案代码" id="code2">
import android.app.Activity;
import android.os.Bundle;
import android.support.v4.view.AccessibilityDelegateCompat;
import android.support.v4.view.ViewCompat;
import android.view.View;
import android.view.accessibility.AccessibilityEvent;
import android.widget.NumberPicker;
import android.widget.NumberPicker.OnValueChangeListener;
import android.widget.TextView;

public class MainActivity extends Activity
{
	NumberPicker np1, np2;
	TextView result;
	// 定义最低价格、最高价格的初始值
	int minPrice = 25, maxPrice = 75;
	@Override
	protected void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);
		
		result = (TextView) findViewById(R.id.result);
		np1 = (NumberPicker) findViewById(R.id.np1);
		// 设置np1的最小值和最大值
		np1.setMinValue(10);
		np1.setMaxValue(50);
		// 设置np1的当前值
		np1.setValue(minPrice);
		np1.setOnLongPressUpdateInterval(200);
		//给NumberPicker设置无障碍代理
		ViewCompat.setAccessibilityDelegate(np1, mDelegate);
		np1.setOnValueChangedListener(new OnValueChangeListener()
		{
			// 当NumberPicker的值发生改变时，将会激发该方法
			@Override
			public void onValueChange(NumberPicker picker, int oldVal, int newVal)
			{
				minPrice = newVal;
			picker.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_SELECTED);
			result.setText("你的选择是：最低价格"+ String.valueOf(minPrice) +"最高价格"+ String.valueOf(maxPrice));
			}
		});
		np2 = (NumberPicker) findViewById(R.id.np2);
		// 设置np2的最小值和最大值
		np2.setMinValue(60);
		np2.setMaxValue(100);
		// 设置np2的当前值
		np2.setValue(maxPrice);
		//给NumberPicker设置无障碍代理
		ViewCompat.setAccessibilityDelegate(np2, mDelegate);
		np2.setOnValueChangedListener(new OnValueChangeListener()
		{
			// 当NumberPicker的值发生改变时，将会激发该方法
			@Override
			public void onValueChange(NumberPicker picker, int oldVal,int newVal)
			{
				maxPrice = newVal;
				picker.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_SELECTED);
				result.setText("你的选择是：最低价格"+ String.valueOf(minPrice) +"最高价格"+ String.valueOf(maxPrice));
}
});

	}

	private AccessibilityDelegateCompat mDelegate = new AccessibilityDelegateCompat() {
	//NumberPicker本身的sendAccessibilityEvent()方法没有做任何处理，所以要重写此方法
	@Override
	public void sendAccessibilityEvent(View host,int eventType) {
		super.sendAccessibilityEvent(host, eventType);
	}

	@Override
	public void onPopulateAccessibilityEvent(View host, AccessibilityEvent event ){
		super.onPopulateAccessibilityEvent(host, event);
		//在事件中添加文本
		event.getText().add( String.valueOf(((NumberPicker)host).getValue()));
	}
	};
}
        </textarea><br/>
        <a href="#" id="copy_input2" class="copy">复制内容</a> 
    </div>
    <div>
        <h4>【前后效果图对比】</h4>
        <hr />
        <table>
            <tr>
                <td><img src="../images/39-1.png" class="litu" alt="" aria-labelledby="img1_label"/></td><td><img src="../images/39-2.png" class="litu" alt="" aria-labelledby="img2_label"/></td>
            </tr>
            <tr>
                <td id="img1_label">优化前，双击备选项目，备选被选中，语音无提示；</td><td id="img2_label">优化后，双击备选项目，备选被选中，语音提示哪个备选被选中，例如“28”；</td>
            </tr>
        </table>
    </div>
    <div>
        <h4>【扩展】</h4>
        <hr />
        <p>让NumberPicker及时朗读值的改变效果<a href="../apk/39_apk.apk">apk</a></p>
    </div>
    <div>
        <h4>【更多】</h4>
        <hr />
        <p><a name="fujian1"></a>【附】 布局文件的代码</p>
		<textarea rows="43" cols="120" aria-label="解决方案代码" id="code3">
<?xml version="1.0" encoding="utf-8"?>
<TableLayout
	xmlns:android="http://schemas.android.com/apk/res/android"
	android:layout_width="match_parent"
	android:layout_height="wrap_content">
	<TableRow
		android:layout_width="match_parent"
		android:layout_height="wrap_content">
		<TextView
			android:focusable="true"
			android:text="选择低价："
			android:layout_width="120dp"
			android:layout_height="wrap_content" />
		<NumberPicker
			android:id="@+id/np1"
			android:layout_width="match_parent"
			android:layout_height="80dp"
			android:focusable="true"
			android:focusableInTouchMode="true"
			android:accessibilityLiveRegion="assertive"/>
	</TableRow>
	<TableRow
		android:layout_width="match_parent"
		android:layout_height="wrap_content">
		<TextView
			android:text="选择高价："
			android:layout_width="120dp"
			android:layout_height="wrap_content" />
		<NumberPicker
			android:id="@+id/np2"
			android:layout_width="match_parent"
			android:layout_height="80dp"
			android:focusable="true"
			android:focusableInTouchMode="true"
			android:accessibilityLiveRegion="polite"/>
	</TableRow>
	<TableRow
		android:layout_width="match_parent"
		android:layout_height="wrap_content">
		<TextView
			android:id="@+id/result"
			android:layout_width="match_parent"
			android:layout_height="wrap_content"/>
	</TableRow>
</TableLayout>
		 </textarea><br/>
        <a href="#" id="copy_input3" class="copy">复制内容</a> 
    </div>
</div>
<!-- body end -->
<br/>
<hr/>
<!-- footer begin -->
<div class="footer">
<p class="copyright">深圳市信息无障碍研究会 版权所有.Copyright © 2016 ARA. All 
Rights Reserved. <a href="http://www.miibeian.gov.cn/" target="_blank">粤ICP备10065437号</a> </p>
<p class="copyright">地址：深圳市福田区雨田路1号富莲大厦一栋一层</p>
</div>
<!-- footer end -->
</div>
<!-- wrap end -->
</body>
</html>
