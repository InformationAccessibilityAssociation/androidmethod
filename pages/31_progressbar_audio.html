<!DOCTYPE html>

<html lang="zh-CN">
<head>
<title>用AccessibilityDelegate使标准的进度条进度更新有声音提示</title>
<link rel="stylesheet" href="../style.css" />
<meta charset="utf-8">
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery.zclip.min.js"></script>
<script type="text/javascript">
$(function(){ 
    $('#copy_input1').zclip({ 
        path: 'js/ZeroClipboard.swf', 
        copy: function(){//复制内容 
            return $('#code1').val(); 
        }, 
        afterCopy: function(){//复制成功 
            $("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功'); 
        } 
    }); 
}); 
$(function(){ 
    $('#copy_input2').zclip({ 
        path: 'js/ZeroClipboard.swf', 
        copy: function(){//复制内容 
            return $('#code2').val(); 
        }, 
        afterCopy: function(){//复制成功 
            $("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功'); 
        } 
    }); 
}); 
</script>
</head>
<body>
<div class="wrap">
<!-- header begin -->
<div class="header">
    <div ><a href="http://www.siaa.org.cn/"><img src="../logo.png" alt="信息无障碍研究会"  class="logo"/></a></div>
    <!-- nav bar begin -->
    <div class="nav-bar">
        <!-- nav menu begin -->
        <ul>
            <li><a href="../index.html">首页</a></li>
            <li><a href="../index.html">返回</a></li>
        </ul>
        <!-- nav menu end -->
    </div>
    <!-- nav bar end -->
</div>
<!-- header end -->

<!-- body begin -->
<div class="body">
    <h3>用AccessibilityDelegate使标准的进度条进度更新有声音提示____20160523</h3>
    <hr />
    <div>
        <h4>【问题描述】</h4>
        <hr />
        <p>Android系统的标准进度条（ProgressBar）在默认的情况下没有焦点，当进度条是可以显示进度的时候进度改变也没有提示。这样的话屏幕阅读器用户很难知道执行的任务完成的进度情况，如当用户在下载歌曲的时候用一个进度条（ProgressBar）提示下载进度，这时用户就很难知道当前下载的进度了。</p><!--问题说明-->
    </div>
    <div>
        <h4>【问题代码】</h4>
        <hr />
        <p>下面的代码是MainActivity.java中的代码，布局文件的代码请参看“附1”。下面的代码中的两个进度条都没有焦点且第二个有进度提示的进度条进度变化的时候没有任何提示。</p>
        <textarea rows="70" cols="120" aria-label="问题代码" id="code1">
import android.app.Activity;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.widget.ProgressBar;

public class MainActivity extends Activity
{
	// 该程序模拟填充长度为100的数组
	private int[] data = new int[100];
	int hasData = 0;
	// 记录ProgressBar的完成进度
	int status = 0;
	ProgressBar bar ,progress;
	// 创建一个负责更新的进度的Handler
	Handler mHandler = new Handler()
	{
		@Override
		public void handleMessage(Message msg)
		{
			// 表明消息是由该程序发送的
			if (msg.what == 0x111)
			{
				bar.setProgress(status);
			}
		}
	};

	@Override
	public void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);

		bar = (ProgressBar) findViewById(R.id.bar);
		progress= (ProgressBar) findViewById(R.id.progress);

		// 启动线程来执行任务
		new Thread()
		{
			public void run()
			{
				while (status < 100)
				{
					// 获取耗时操作的完成百分比
					status = doWork();
					// 发送消息
					mHandler.sendEmptyMessage(0x111);
				}
			}
		}.start();
	}

	// 模拟一个耗时的操作
	public int doWork()
	{
		// 为数组元素赋值
		data[hasData++] = (int) (Math.random() * 100);
		try
		{
			Thread.sleep(200);
		}
		catch (InterruptedException e)
		{
			e.printStackTrace();
		}
		return hasData;
	}

}
        </textarea><br/>
        <a href="#" id="copy_input1" class="copy">复制内容</a> 
    </div>
    <div>
        <h4>【问题解决方案描述】</h4>
        <hr />
        <p>在使用标准控件进度条（ProgressBar）的时候，使用没有进度的进度条时，任务在执行的时候给进度条添加替代文本(android:contentDescription)并使其有焦点，这样用户能浏览到进度条且根据替代文本知道任务正在执行，当任务完成之后把进度条的替代文本设置为空并使其没有焦点；当使用有进度提示的进度条的时候用setAccessibilityDelegate()方法给控件添加View.AccessibilityDelegate并重写此类中的onInitializeAccessibilityNodeInfo()方法，在此方法中利用AccessibilityNodeInfo.RangeInfo类给控件添加进度的提示，然后必须把此控件设置为有焦点，在这种情况下TalkBack会发出从低到高的声音来提示进度的变化。</p>
		<p>注：
有进度的进度条用AccessibilityNodeINfo.rangeInfo添加进度提示之后不要添加替代文本，如果添加了替代文本TalkBack会一直朗读替代文本，这样的体验非常不好。
用AccessibilityNodeInfo.RangeInfo添加进度提示之后必须让进度条有焦点TalkBack才能发出从低到高的进度提示声音。
</p>
    </div>
    <div>
        <h4>【解决方案】</h4>
        <hr />
		<p>下面的代码实现了当进度在动的时候，没有进度提示的进度条有焦点有提示文本；有进度提示的进度条能根据进度的变化发出高低不同的声音，进度条快满的时候声调高。（TalkBack下测试过）</p>
        <textarea rows="94" cols="120" aria-label="解决方案代码" id="code2">
import android.app.Activity;
import android.os.Bundle;
import android.os.Handler;
import android.os.Message;
import android.view.View;
import android.view.accessibility.AccessibilityNodeInfo;
import android.widget.ProgressBar;

public class MainActivity extends Activity
{
	// 该程序模拟填充长度为100的数组
	private int[] data = new int[100];
	int hasData = 0;
	// 记录ProgressBar的完成进度
	int status = 0;
	ProgressBar bar ,progress;
	// 创建一个负责更新的进度的Handler
	Handler mHandler = new Handler()
	{
		@Override
		public void handleMessage(Message msg)
		{
			// 表明消息是由该程序发送的
			if (msg.what == 0x111)
			{
				bar.setProgress(status);
				//当任务完成之后把没有进度的进度条的替代文本去掉，把两个进度条的焦点去掉。
				if (status == 100) {
					bar.setFocusable(false);
					bar.setFocusableInTouchMode(false);
					progress.setContentDescription("");
					progress.setFocusable(false);
					progress.setFocusableInTouchMode(false);				
				}
			}
		}
	};

	@Override
	public void onCreate(Bundle savedInstanceState)
	{
		super.onCreate(savedInstanceState);
		setContentView(R.layout.main);
		bar = (ProgressBar) findViewById(R.id.bar);
		progress= (ProgressBar) findViewById(R.id.progress);
		//给没有进度的进度条设置替代文本和焦点
		progress.setFocusable(true);
		progress.setFocusableInTouchMode(true);
		progress.setContentDescription("任务完成的进度");
		//给有进度的进度条设置AccessibilityDelegate和焦点
		bar.setAccessibilityDelegate(mDelegate);
		bar.setFocusable(true);
		bar.setFocusableInTouchMode(true);

		// 启动线程来执行任务
		new Thread()
		{
			public void run()
			{
				while (status < 100)
				{
					// 获取耗时操作的完成百分比
					status = doWork();
					// 发送消息
					mHandler.sendEmptyMessage(0x111);
				}
			}
		}.start();
	}

	// 模拟一个耗时的操作
	public int doWork()
	{
		// 为数组元素赋值
		data[hasData++] = (int) (Math.random() * 100);
		try
		{
			Thread.sleep(200);
		}
		catch (InterruptedException e)
		{
			e.printStackTrace();
		}
		return hasData;
	}

	private View.AccessibilityDelegate mDelegate = new View.AccessibilityDelegate() {
		@Override
		public void onInitializeAccessibilityNodeInfo(View host, AccessibilityNodeInfo info) {
			super.onInitializeAccessibilityNodeInfo(host, info);
			AccessibilityNodeInfo.RangeInfo progress = AccessibilityNodeInfo.RangeInfo.obtain(AccessibilityNodeInfo.RangeInfo.RANGE_TYPE_PERCENT, 0, bar.getMax(), bar.getProgress());
			info.setRangeInfo(progress);
			}
	};
}

        </textarea><br/>
        <a href="#" id="copy_input2" class="copy">复制内容</a> 
    </div>
    <div>
        <h4>【前后效果图对比】</h4>
        <hr />
        <table>
            <tr>
                <td><img src="../images/31-1.png" class="litu" alt="" aria-labelledby="img1_label"/></td><td><img src="../images/31-2.png" class="litu" alt="" aria-labelledby="img2_label"/></td>
            </tr>
            <tr>
                <td id="img1_label">优化前，进度条无焦点，无声音提示；</td><td id="img2_label">优化后，进度条有焦点，聚焦时，有声音提声音提示，进度越大，声调越高；</td>
            </tr>
        </table>
    </div>
    <div>
        <h4>【扩展】</h4>
        <hr />
        <p>【附1】 MainActivity.xml布局代码</p>
		 <textarea rows="20" cols="120" aria-label="解决方案代码">
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
	android:orientation="vertical"
	android:layout_width="match_parent"
	android:layout_height="match_parent">

		<!-- 定义一个大环形进度条 -->
		<ProgressBar
			android:id="@+id/progress"
			android:layout_width="wrap_content"
			android:layout_height="wrap_content"
			style="@android:style/Widget.ProgressBar.Large"/>

		<TextView
			android:layout_width="match_parent"
			android:layout_height="wrap_content"
			android:text="任务完成的进度"/>
		<!-- 定义一个水平进度条 -->
		<ProgressBar
			android:id="@+id/bar"
			android:layout_width="match_parent"
			android:layout_height="wrap_content"
			android:max="100"
			style="@android:style/Widget.ProgressBar.Horizontal"/>

</LinearLayout>
		 </textarea>
    </div>
    <div>
        <h4>【更多】</h4>
        <hr />
        <ol></ol>
    </div>
</div>
<!-- body end -->

<!-- footer begin -->
<div class="footer">
</div>
<!-- footer end -->
</div>
<!-- wrap end -->
</body>
</html>
