<!DOCTYPE html>

<html lang="zh-CN">
<head>
<title>让不朗读选中状态的标准控件朗读选中状态的正确方法</title>
<link rel="stylesheet" href="../style.css" />
<meta charset="utf-8">
<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/jquery.zclip.min.js"></script>
<script type="text/javascript">
$(function(){ 
    $('#copy_input1').zclip({ 
        path: 'js/ZeroClipboard.swf',  
        copy: function(){//复制内容 
            return $('#code1').val(); 
        }, 
        afterCopy: function(){//复制成功 
            $("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功'); 
        } 
    }); 
}); 
$(function(){ 
    $('#copy_input2').zclip({ 
        path: 'js/ZeroClipboard.swf', 
        copy: function(){//复制内容 
            return $('#code2').val(); 
        }, 
        afterCopy: function(){//复制成功 
            $("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功'); 
        } 
    }); 
}); 
$(function(){ 
    $('#copy_input3').zclip({ 
        path: 'js/ZeroClipboard.swf', 
        copy: function(){//复制内容 
            return $('#code3').val(); 
        }, 
        afterCopy: function(){//复制成功 
            $("<span id='msg'/>").insertAfter($('#copy_input')).text('复制成功'); 
        } 
    }); 
}); 
</script>
</head>
<body>
<div class="wrap">
<!-- header begin -->
<div class="header">
    <div ><a href="http://www.siaa.org.cn/"><img src="../logo.png" alt="信息无障碍研究会"  class="logo"/></a></div>
    <!-- nav bar begin -->
    <div class="nav-bar">
        <!-- nav menu begin -->
        <ul>
            <li><a href="../index.html">首页</a></li>
            <li><a href="../index.html">返回</a></li>
        </ul>
        <!-- nav menu end -->
    </div>
    <!-- nav bar end -->
</div>
<!-- header end -->

<!-- body begin -->
<div class="body">
    <h3>让不朗读选中状态的标准控件朗读选中状态的正确方法____20160519</h3>
    <hr />
    <div>
        <h4>【问题描述】</h4>
        <hr />
        <p>一些产品中会使用没有选中状态的标准控件改变背景颜色、控件形状、大小等来代表选中状态，如：用一个按钮（Button）背景为红色代表选中，背景为白色代表没有选中，因为这些标准控件本身没有选中状态，所以屏幕阅读器不会朗读以样式展示的选中状态，用户就无法知道控件的当前状态。为了让用户知道控件的选中状态一些开发者在控件的android:contentDescription属性中添加了状态，这种方法是不合理的。这种方法破坏了屏幕阅读器本身对于控件的朗读顺序，而且此种方法不能很好的兼容多种语言，还有不同的开发可能会提供不同的词语来表示选中状态，如一些开发者提供“已选中”，另外一些提供“选中”……还有一个比较严重的问题是用此方法设置的选中状态不能及时朗读出，当用户选中之后要重新让此控件获得焦点才能知道当前的选中状态。正确的方法是改变无障碍事件中的选中状态，让屏幕阅读器自己去识别。而且选中状态改变之后能马上朗读出。</p><!--问题说明-->
    </div>
    <div>
        <h4>【问题代码】</h4>
        <hr />
        <p>下面的代码中当状态改变的时候会改变android:contentDescription属性的值来提示用户状态改变。 此代码的mainActivity.xml参见“<a href="#name">附1</a>“ </p>
        <textarea rows="107" cols="120" aria-label="问题代码" id="code1">
import android.app.Activity;
import android.graphics.Color;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;

public class MainActivity extends Activity {  

	//记录天猫按钮的选中状态
	private boolean tianmaoChecked;
	//记录淘宝按钮的选中状态
	private boolean taobaoChecked;
	//天猫按钮
	private Button tianmao;
	//淘宝按钮
	private Button taobao;
    	@Override  
   	 protected void onCreate(Bundle savedInstanceState) {  
       		super.onCreate(savedInstanceState);  
     		setContentView(R.layout.activity_main);
		tianmaoChecked = false;
		taobaoChecked = true;
		tianmao = (Button) findViewById(R.id.tianmao);
		taobao = (Button) findViewById(R.id.taobao);
		tianmao.setOnClickListener(mOnClickListener);
		taobao.setOnClickListener(mOnClickListener);

		if (taobaoChecked) {
			taobao.setBackgroundColor(Color.RED);
			//下面的代码在android:contentDescription属性中自己添加了选中状态的描述
			//taobao.setContentDescription(taobao.getText() +"已选中");
			taobao.setContentDescription("已选中 " +taobao.getText());
		}
		else {
			taobao.setBackgroundColor(Color.WHITE);
			//下面的代码在android:contentDescription属性中自己添加了选中状态的描述
			//taobao.setContentDescription(taobao.getText() + "未选中");
			taobao.setContentDescription("未选中 " +taobao.getText());
		}


		if (tianmaoChecked) {
			tianmao.setBackgroundColor(Color.RED);
			//下面的代码在android:contentDescription属性中自己添加了选中状态的描述
			//tianmao.setContentDescription			(tianmao.getText() + "已选中");
			tianmao.setContentDescription("已选中 " +tianmao.getText());
		}
		else {
tianmao.setBackgroundColor(Color.WHITE);
//下面的代码在android:contentDescription属性中自己添加了选中状态的描述
			//tianmao.setContentDescription(tianmao.getText() + "未选中");
			tianmao.setContentDescription("未选中 " +tianmao.getText());
		}
	}
//点击事件监听器
	private View.OnClickListener mOnClickListener = new View.OnClickListener() {
		@Override
		public void onClick(View v) {
			switch (v.getId()) {
			case R.id.taobao:
			taobaoChecked = !taobaoChecked;
			if (taobaoChecked) {
				taobao.setBackgroundColor(Color.RED);
				//下面的代码在android:contentDescription属性中自己添加了选中状态的描述

				//taobao.setContentDescription(taobao.getText() +"已选中");
				taobao.setContentDescription("已选中 " +taobao.getText());
			}
			else {
				taobao.setBackgroundColor(Color.WHITE);
				//下面的代码在android:contentDescription属性中自己添加了选中状态的描述
				//taobao.setContentDescription(taobao.getText() + "未选中");
				taobao.setContentDescription("未选中 " +taobao.getText());
			}
			break;
			case R.id.tianmao:
			tianmaoChecked = !tianmaoChecked;
			if (tianmaoChecked) {
				tianmao.setBackgroundColor(Color.RED);
				//下面的代码在android:contentDescription属性中自己添加了选中状态的描述
				//tianmao.setContentDescription(tianmao.getText() + "已选中");
				tianmao.setContentDescription("已选中 " +tianmao.getText());
}
			else {
				tianmao.setBackgroundColor(Color.WHITE);
				//下面的代码在android:contentDescription属性中自己添加了选中状态的描述
				//tianmao.setContentDescription(tianmao.getText() + "未选中");
				tianmao.setContentDescription("未选中 " +tianmao.getText());
				}
			break;
		}
	}
};
}
        </textarea><br/>
        <a href="#" id="copy_input1" class="copy">复制内容</a> 
    </div>
    <div>
        <h4>【问题解决方案描述】</h4>
        <hr />
        <p>正确的方法是利用setAccessibilityDelegate()方法给标准控件添加AccessibilityDelegate,在Accessibility中重写onInitializeAccessibilityEvent()和onInitializeAccessibilityNodeInfo()两个方法，在onInitializeAccessibilityEvent()方法中调用AccessibilityEvent.setChecked()方法设置选中状态，在onInitializeAccessibilityNodeInfo()方法中调用AccesibilityNodeInfo.setCheckalbe(true)方法（此方法代表此控件是一个可被选中的控件）、调用AccessibilityNodeInfo.setChecked()设置选中状态。还有在设置选中状态的监听事件（OnClickListener监听器）中调用sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_SELECTED)。这样设置之后的选中状态是由屏幕阅读器自动识别，而且点击之后能正确、及时的朗读出选中状态。</p>
    </div>
    <div>
        <h4>【解决方案】</h4>
        <hr />
		<p>下面是利用添加AccessibilityDelegate方法设置选中状态的代码：</p>
        <textarea rows="104" cols="120" aria-label="解决方案代码" id="code2">
import android.app.Activity;
import android.graphics.Color;
import android.os.Bundle;
import android.view.View;
import android.view.View.AccessibilityDelegate;
import android.view.accessibility.AccessibilityEvent;
import android.view.accessibility.AccessibilityNodeInfo;
import android.widget.Button;

public class MainActivity extends Activity {  

//记录天猫按钮的选中状态
	private boolean tianmaoChecked;
	private boolean taobaoChecked;

   	 @Override  
   	protected void onCreate(Bundle savedInstanceState) {  
       		super.onCreate(savedInstanceState);  
        	setContentView(R.layout.activity_main);
		tianmaoChecked = false;
		taobaoChecked = true;

		Button tianmao = (Button) findViewById(R.id.tianmao);
		Button taobao = (Button) findViewById(R.id.taobao);
		tianmao.setOnClickListener(mOnClickListener);
		taobao.setOnClickListener(mOnClickListener);
		//下面两行是为两个按钮设置AccessibilityDelegate
		tianmao.setAccessibilityDelegate(mDelegate);
		taobao.setAccessibilityDelegate(mDelegate);
		if (tianmaoChecked) {
			tianmao.setBackgroundColor(Color.RED);
		}
		else {
			tianmao.setBackgroundColor(Color.WHITE);
		}

		if (taobaoChecked) {
			taobao.setBackgroundColor(Color.RED);
		}
		else {
			taobao.setBackgroundColor(Color.WHITE);
		}
	}

	//AccessibilityDelegate（无障碍代理）
	//在此代理之中重写了onInitializeAccessibilityEvent()和	onInitializeAccessibilityNodeInfo()方法并在这两个方法中对选中状态进行设置
	private AccessibilityDelegate mDelegate = new AccessibilityDelegate() {
		@Override
		public void onInitializeAccessibilityEvent(View host, AccessibilityEvent event) {
			super.onInitializeAccessibilityEvent(host, event);
			//下面的代码根据控件id不同设置项对应的控件的选中状态
			switch (host.getId() ) {
			case R.id.tianmao:
			event.setChecked(tianmaoChecked);
			break;
			case R.id.taobao:
			event.setChecked(taobaoChecked);
			break;
			}
	}
	@Override
	public void onInitializeAccessibilityNodeInfo(View host, AccessibilityNodeInfo info) {
		super.onInitializeAccessibilityNodeInfo(host, info);
		//此行代码设置了此控件是可被选中的，此行代码是必须的，如果没有此行代码设置了选中状态也不会朗读出
		info.setCheckable(true);
		//下面的代码根据控件的id不同设置相应的选中状态
		switch (host.getId()) {
			case R.id.tianmao:
			info.setChecked(tianmaoChecked);
			break;
			case R.id.taobao:
			info.setChecked(taobaoChecked);
			break;
			}
		}
	}; 
//点击事件监听器
private View.OnClickListener mOnClickListener = new View.OnClickListener() {
	@Override
	public void onClick(View v) {
		switch (v.getId()) {
			case R.id.taobao:
			taobaoChecked = !taobaoChecked;
			if (taobaoChecked) {
				v.setBackgroundColor(Color.RED);
			}
			else {
				v.setBackgroundColor(Color.WHITE);
			}
			break;
			case R.id.tianmao:
			tianmaoChecked = !tianmaoChecked;
			if (tianmaoChecked) {
				v.setBackgroundColor(Color.RED);
			}
			else {
				v.setBackgroundColor(Color.WHITE);
			}
			break;
		}
	//在监听器的最后发送无障碍事件，
	//onClick监听默认发送的是TYPE_VIEW_CLICKED事件，会导致点击之后立即播报的选中状态是改变之前的
	//发送type_view_selected无障碍事件就可以解决此问题，点击之后立即播报的选中状态就是当前的状态了。
	v.sendAccessibilityEvent(AccessibilityEvent.TYPE_VIEW_SELECTED);
}
};
}
        </textarea><br/>
        <a href="#" id="copy_input2" class="copy">复制内容</a> 
    </div>
    <div>
        <h4>【前后效果图对比】</h4>
        <hr />
        <table>
            <tr>
                <td><img src="../images/26-1.png" class="litu" alt="" aria-labelledby="img1_label"/></td><td><img src="../images/26-2.png" class="litu" alt="" aria-labelledby="img2_label"/></td>
            </tr>
            <tr>
                <td id="img1_label">优化前，聚焦朗读“未选中 天猫按钮”，点击响应事件，无语音提示，重新聚焦朗读“已选中 天猫按钮”，点击响应事件，无语音提示；</td><td id="img2_label">优化后，聚焦朗读“未选中 天猫按钮”，点击响应事件，提示“天猫 已选中”，重新聚焦朗读“已选中 天猫按钮”，点击响应事件，提示“天猫 未选中”；</td>
            </tr>
        </table>
    </div>
    <div>
        <h4>【扩展】</h4>
        <hr />
		<a href="" name="fujian"></a>
        <p>【附1】 MainActivity。Xml布局文件代码</p>
		<textarea rows="23" cols="120" aria-label="附件1" id="code3">
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout
	xmlns:android="http://schemas.android.com/apk/res/android"
	android:layout_width="match_parent"
	android:layout_height="match_parent"
	android:orientation="vertical">

	<Button
		android:layout_width="50dp"
		android:layout_height="50dp"
		android:text="天猫"
		android:textSize="40dp"
		android:id="@+id/tianmao"
		android:background="#000000"/>

	<Button
		android:layout_width="50dp"
		android:layout_height="50dp"
		android:text="淘宝"
		android:textSize="40dp"
		android:id="@+id/taobao"
		android:background="#000000"/>
</LinearLayout>
		</textarea><br/>
        <a href="#" id="copy_input3" class="copy">复制内容</a> 
    </div>
    <div>
        <h4>【更多】</h4>
        <hr />
        <ol></ol>
    </div>
</div>
<!-- body end -->

<!-- footer begin -->
<div class="footer">
</div>
<!-- footer end -->
</div>
<!-- wrap end -->
</body>
</html>
